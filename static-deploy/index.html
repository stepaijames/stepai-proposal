<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STEP AI (ì •ë¶€) ì§€ì› ì‚¬ì—… í˜„í™©íŒ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif; background: #f8fafc; min-height: 100vh; color: #1e293b; padding: 24px; font-size: 16px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 32px; padding: 32px; background: #fff; border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
        .header h1 { font-size: 2rem; margin-bottom: 8px; color: #0f172a; font-weight: 700; }
        .header .update-date { color: #64748b; font-size: 1rem; }
        .sync-status { display: inline-block; margin-left: 12px; padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: 600; }
        .sync-status.online { background: #d1fae5; color: #065f46; }
        .sync-status.offline { background: #fee2e2; color: #991b1b; }
        .pipeline-section { background: #fff; border-radius: 16px; padding: 24px; margin-bottom: 32px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
        .pipeline-title { font-size: 1.1rem; color: #475569; margin-bottom: 20px; font-weight: 600; }
        .pipeline { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 8px; }
        .pipeline-stage { flex: 1; min-width: 140px; padding: 16px 12px; border-radius: 12px; text-align: center; cursor: pointer; transition: all 0.2s; border: 2px solid transparent; position: relative; }
        .pipeline-stage:hover { transform: translateY(-2px); }
        .pipeline-stage.active { border-color: #3b82f6; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2); }
        .pipeline-stage .stage-icon { font-size: 1.5rem; margin-bottom: 8px; }
        .pipeline-stage .stage-count { font-size: 1.8rem; font-weight: 700; margin-bottom: 4px; }
        .pipeline-stage .stage-label { font-size: 0.9rem; font-weight: 600; }
        .stage-all { background: #f1f5f9; } .stage-all .stage-count { color: #475569; } .stage-all .stage-label { color: #64748b; }
        .stage-review { background: #fef3c7; } .stage-review .stage-count { color: #b45309; } .stage-review .stage-label { color: #92400e; }
        .stage-writing { background: #dbeafe; } .stage-writing .stage-count { color: #1d4ed8; } .stage-writing .stage-label { color: #1e40af; }
        .stage-submitted { background: #e0e7ff; } .stage-submitted .stage-count { color: #4338ca; } .stage-submitted .stage-label { color: #3730a3; }
        .stage-evaluating { background: #fce7f3; } .stage-evaluating .stage-count { color: #be185d; } .stage-evaluating .stage-label { color: #9d174d; }
        .stage-selected { background: #d1fae5; } .stage-selected .stage-count { color: #047857; } .stage-selected .stage-label { color: #065f46; }
        .stage-rejected { background: #fee2e2; } .stage-rejected .stage-count { color: #dc2626; } .stage-rejected .stage-label { color: #991b1b; }
        .stage-dropped { background: #f1f5f9; } .stage-dropped .stage-count { color: #64748b; } .stage-dropped .stage-label { color: #475569; }
        .stage-deadline { background: #fef2f2; } .stage-deadline .stage-count { color: #dc2626; } .stage-deadline .stage-label { color: #991b1b; }
        .pipeline-stage:not(:last-child):not(:nth-last-child(2))::after { content: 'â†’'; position: absolute; right: -14px; top: 50%; transform: translateY(-50%); color: #cbd5e1; font-size: 1.2rem; font-weight: bold; }
        .cards-section { margin-bottom: 32px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .section-title { font-size: 1.3rem; color: #0f172a; font-weight: 700; }
        .filter-info { font-size: 0.95rem; color: #64748b; background: #f1f5f9; padding: 8px 16px; border-radius: 20px; }
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 20px; }
        .project-card { background: #fff; border-radius: 16px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.08); transition: all 0.3s; border: 2px solid #e2e8f0; display: none; flex-direction: column; }
        .project-card.visible { display: flex; }
        .project-card:hover { transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0,0,0,0.1); border-color: #cbd5e1; }
        .card-header { padding: 20px 24px; display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 1px solid #f1f5f9; }
        .card-title { font-size: 1.15rem; font-weight: 700; margin-bottom: 6px; line-height: 1.4; color: #0f172a; }
        .card-org { font-size: 0.9rem; color: #64748b; font-weight: 500; }
        .d-day { background: #ef4444; color: #fff; padding: 8px 14px; border-radius: 8px; font-weight: 700; font-size: 0.95rem; white-space: nowrap; }
        .d-day.safe { background: #22c55e; }
        .d-day.warning { background: #f59e0b; }
        .d-day.complete { background: #6366f1; }
        .card-body { padding: 20px 24px; flex: 1; display: flex; flex-direction: column; }
        .card-info { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
        .info-item { background: #f8fafc; padding: 12px 14px; border-radius: 10px; border: 1px solid #e2e8f0; }
        .info-item.full-width { grid-column: 1 / -1; }
        .info-label { font-size: 0.75rem; color: #64748b; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
        .info-value { font-size: 1rem; font-weight: 600; color: #1e293b; }
        .status-dropdown-wrapper { margin-bottom: 16px; margin-top: auto; }
        .status-dropdown-label { font-size: 0.75rem; color: #64748b; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
        .status-dropdown {
            width: 100%;
            padding: 12px 16px;
            font-size: 0.95rem;
            font-weight: 600;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            background: #fff;
            color: #1e293b;
            cursor: pointer;
            transition: all 0.2s;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 20px;
        }
        .status-dropdown:hover { border-color: #3b82f6; }
        .status-dropdown:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .status-dropdown.status-review { background-color: #fef3c7; border-color: #fbbf24; color: #92400e; }
        .status-dropdown.status-writing { background-color: #dbeafe; border-color: #60a5fa; color: #1e40af; }
        .status-dropdown.status-submitted { background-color: #e0e7ff; border-color: #818cf8; color: #3730a3; }
        .status-dropdown.status-evaluating { background-color: #fce7f3; border-color: #f472b6; color: #9d174d; }
        .status-dropdown.status-selected { background-color: #d1fae5; border-color: #34d399; color: #065f46; }
        .status-dropdown.status-rejected { background-color: #fee2e2; border-color: #f87171; color: #991b1b; }
        .status-dropdown.status-dropped { background-color: #f1f5f9; border-color: #94a3b8; color: #475569; }
        .link-btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; width: 100%; background: #3b82f6; color: #fff; padding: 12px 16px; border-radius: 10px; font-size: 0.95rem; font-weight: 600; text-decoration: none; transition: background 0.2s, transform 0.2s; }
        .link-btn:hover { background: #2563eb; transform: translateY(-1px); }
        .link-btn svg { width: 18px; height: 18px; }
        .footer { text-align: center; padding: 24px; color: #64748b; font-size: 0.95rem; background: #fff; border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
        .footer a { color: #3b82f6; text-decoration: none; font-weight: 600; }
        .footer a:hover { text-decoration: underline; }
        .empty-state { text-align: center; padding: 60px 20px; color: #94a3b8; display: none; }
        .empty-state.visible { display: block; }
        .empty-state .empty-icon { font-size: 3rem; margin-bottom: 16px; }
        .empty-state .empty-text { font-size: 1.1rem; }
        .save-indicator {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.9rem;
            z-index: 1000;
            transition: all 0.3s;
            opacity: 0;
            transform: translateY(20px);
        }
        .save-indicator.show { opacity: 1; transform: translateY(0); }
        .save-indicator.saving { background: #dbeafe; color: #1e40af; }
        .save-indicator.saved { background: #d1fae5; color: #065f46; }
        .save-indicator.error { background: #fee2e2; color: #991b1b; }
        @media (max-width: 768px) { .header h1 { font-size: 1.5rem; } .pipeline { flex-wrap: wrap; } .pipeline-stage { min-width: calc(33% - 8px); } .pipeline-stage::after { display: none; } .cards-grid { grid-template-columns: 1fr; } body { padding: 16px; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>STEP AI (ì •ë¶€) ì§€ì› ì‚¬ì—… í˜„í™©íŒ</h1>
            <p class="update-date"></p>
        </div>
        <div class="pipeline-section">
            <div class="pipeline-title">ğŸ“Š ì§„í–‰ ë‹¨ê³„ë³„ í˜„í™© (í´ë¦­í•˜ì—¬ í•„í„°ë§)</div>
            <div class="pipeline" id="pipelineContainer"></div>
        </div>
        <div class="cards-section">
            <div class="section-header"><h2 class="section-title">ğŸ“‹ ì‚¬ì—… ëª©ë¡</h2><span class="filter-info" id="filterInfo"></span></div>
            <div class="cards-grid" id="cardsGrid"></div>
            <div class="empty-state" id="emptyState"><div class="empty-icon">ğŸ“­</div><div class="empty-text">í•´ë‹¹ ë‹¨ê³„ì˜ ì‚¬ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</div></div>
        </div>
        <div class="footer">
            <p>STEP AI Inc. â€” ë‚´ë¶€ í˜‘ì—…ìš© ë¬¸ì„œ</p>
            <p style="margin-top: 10px;"><a href="https://kculture-detail.vercel.app/" target="_blank">K-Culture ëŒ€ì¤‘ì†Œ ê³µë™ë„ì•½ ìƒì„¸ â†’</a></p>
        </div>
    </div>

    <div class="save-indicator" id="saveIndicator"></div>

    <script>
        // ==========================================
        // STATUSES ì •ì˜
        // ==========================================
        const STATUSES = [
            { key: 'all',        label: 'ì „ì²´',     icon: 'ğŸ“‹', stageClass: 'stage-all' },
            { key: 'review',     label: 'ê²€í† ì¤‘',   icon: 'ğŸ”', stageClass: 'stage-review' },
            { key: 'writing',    label: 'ì‘ì„±ì¤‘',   icon: 'âœï¸', stageClass: 'stage-writing' },
            { key: 'submitted',  label: 'ì œì¶œì™„ë£Œ', icon: 'ğŸ“¤', stageClass: 'stage-submitted' },
            { key: 'evaluating', label: 'ì‹¬ì‚¬ì¤‘',   icon: 'â³', stageClass: 'stage-evaluating' },
            { key: 'selected',   label: 'ì„ ì •',     icon: 'âœ…', stageClass: 'stage-selected' },
            { key: 'rejected',   label: 'íƒˆë½',     icon: 'âŒ', stageClass: 'stage-rejected' },
            { key: 'dropped',    label: 'ë“œë',     icon: 'â¹ï¸', stageClass: 'stage-dropped' },
            { key: 'deadline',   label: 'ë§ˆê°ì¼ì', icon: 'ğŸ“…', stageClass: 'stage-deadline' }
        ];

        // ==========================================
        // ìƒíƒœ ë§¤í•‘: ì˜ì–´ key â†” í•œê¸€ (Supabase)
        // ==========================================
        const STATUS_KEY_TO_KR = {
            'review': 'ê²€í† ì¤‘',
            'writing': 'ì‘ì„±ì¤‘',
            'submitted': 'ì œì¶œì™„ë£Œ',
            'evaluating': 'ì‹¬ì‚¬ì¤‘',
            'selected': 'ì„ ì •',
            'rejected': 'íƒˆë½',
            'dropped': 'ë“œë'
        };
        const STATUS_KR_TO_KEY = {};
        Object.entries(STATUS_KEY_TO_KR).forEach(([k, v]) => { STATUS_KR_TO_KEY[v] = k; });

        // ==========================================
        // SSOT: projects[] â€” í”„ë¡ íŠ¸ì—”ë“œ ë‹¨ì¼ ë°ì´í„° ì†ŒìŠ¤
        // supabaseId: Supabase gov_projects í…Œì´ë¸”ì˜ id
        // ==========================================
        const projects = [
            {
                id: 'startup',
                supabaseId: 1,
                title: 'ì´ˆê¸°ì°½ì—…íŒ¨í‚¤ì§€ (ì¼ë°˜í˜•)',
                agency: 'ì¤‘ì†Œë²¤ì²˜ê¸°ì—…ë¶€ / ì°½ì—…ì§„í¥ì›',
                deadline: '2026-02-13T16:00',
                budget: 'ìµœëŒ€ 1ì–µì›',
                status: 'review',
                category: 'ì •ë¶€ì§€ì›ì‚¬ì—…',
                link: 'https://www.k-startup.go.kr/web/contents/bizpbanc-ongoing.do?pbancClssCd=PBC010&schM=view&pbancSn=176019',
                note: 'ìê²©ìš”ê±´ ë¦¬ìŠ¤í¬: ëŒ€í‘œì ê¸°ì¡´ ë²•ì¸ ë³´ìœ  ì´ë ¥'
            },
            {
                id: 'kculture',
                supabaseId: 4,
                title: 'K-Culture ëŒ€ì¤‘ì†Œ ê³µë™ë„ì•½ â­',
                agency: 'ë¬¸í™”ì²´ìœ¡ê´€ê´‘ë¶€ / í•œêµ­ì½˜í…ì¸ ì§„í¥ì›',
                deadline: '2026-02-25T14:00',
                budget: 'ì•½ 77ì–µì› (3ë…„)',
                status: 'writing',
                category: 'ì •ë¶€ì§€ì›ì‚¬ì—…',
                link: 'https://www.kocca.kr/kocca/pims/view.do?intcNo=126D00079001&menuNo=204104&recptSt=204104&category=&pageIndex=3&search=01&searchWrd=',
                note: 'KT ENA í˜‘ì˜ ì¤‘'
            },
            {
                id: 'kocca-creative',
                supabaseId: 5,
                title: 'KOCCA ê¸°ì—…ì°½ì‘ì „ë‹´ë¶€ì„œ ì¸ì •',
                agency: 'ë¬¸í™”ì²´ìœ¡ê´€ê´‘ë¶€ / í•œêµ­ì½˜í…ì¸ ì§„í¥ì›',
                deadline: '2026-02-27T16:00',
                budget: 'ë²•ì¸ì„¸ ì„¸ì•¡ê³µì œ',
                status: 'evaluating',
                category: 'ì¸ì¦/ì‹ ê³ ',
                link: 'https://www.kocca.kr/kocca/bbs/view/B0000137/2010505.do?menuNo=204802'
            },
            {
                id: 'broadcast-docu',
                supabaseId: 2,
                title: 'ë°©ì†¡ì˜ìƒì½˜í…ì¸ ì œì‘ì§€ì› (ë‹¤í)',
                agency: 'í•œêµ­ì½˜í…ì¸ ì§„í¥ì› (KOCCA)',
                deadline: '2026-03-04T14:00',
                budget: 'ìµœëŒ€ 1.5ì–µì›',
                status: 'review',
                category: 'ì •ë¶€ì§€ì›ì‚¬ì—…',
                link: 'https://www.kocca.kr/kocca/pims/view.do?intcNo=126J261007&menuNo=204104'
            },
            {
                id: 'venture',
                supabaseId: 6,
                title: 'ë²¤ì²˜ê¸°ì—… ì¸ì¦',
                agency: 'ì¤‘ì†Œë²¤ì²˜ê¸°ì—…ë¶€ / ë²¤ì²˜ì¸',
                deadline: '2026-02-11',
                budget: 'ì„¸ì œ/ê¸ˆìœµ í˜œíƒ',
                status: 'evaluating',
                category: 'ì¸ì¦/ì‹ ê³ ',
                link: 'https://www.smes.go.kr/venturein/home/viewHome',
                note: '2/11 ìµœì¢…ì‹¬ì˜ ì˜ˆì •'
            },
            {
                id: 'broadcast-reg',
                supabaseId: 7,
                title: 'ë°©ì†¡ì˜ìƒë…ë¦½ì œì‘ì‚¬ ì‹ ê³ ',
                agency: 'ë¬¸í™”ì²´ìœ¡ê´€ê´‘ë¶€',
                deadline: null,
                budget: 'ë°©ì†¡ ì œì‘ ìê²©',
                status: 'selected',
                category: 'ì¸ì¦/ì‹ ê³ ',
                link: 'https://production.mcst.go.kr/user/main.do',
                note: 'ì‹ ê³ ë²ˆí˜¸ ì œ12351í˜¸'
            },
            {
                id: 'copyright',
                supabaseId: 8,
                title: 'í•œêµ­ì €ì‘ê¶Œìœ„ì›íšŒ ë“±ë¡',
                agency: 'í•œêµ­ì €ì‘ê¶Œìœ„ì›íšŒ',
                deadline: '2026-03-01',
                budget: 'ì €ì‘ê¶Œ ë³´í˜¸',
                status: 'writing',
                category: 'ì¸ì¦/ì‹ ê³ ',
                link: 'https://www.cros.or.kr/psnsys/cmmn/infoPage.do?w2xPath=/ui/main/main.xml',
                note: 'ë³´ì™„ì‚¬í•­ í•´ê²° ì¤‘'
            }
        ];

        // ==========================================
        // Supabase Configuration
        // ==========================================
        const SUPABASE_URL = 'https://yihgjkfyaynfjbodefzm.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlpaGdqa2Z5YXluZmpib2RlZnptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwNjQ4NTQsImV4cCI6MjA4NTY0MDg1NH0.KS6L2v3UtB3QJdYeW1tW-Kna_wlHO_37Ykq6jiueIMg';

        let supabaseClient = null;
        let isSupabaseOnline = false;

        try {
            if (typeof window.supabase !== 'undefined' && window.supabase.createClient) {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('[Supabase] Client created');
            } else {
                console.warn('[Supabase] SDK not loaded â€” offline mode');
            }
        } catch (e) {
            console.warn('[Supabase] Init failed â€” offline mode:', e);
        }

        const STORAGE_KEY = 'stepai-project-statuses';

        // ==========================================
        // localStorage (Fallback)
        // ==========================================
        function saveToLocalStorage() {
            const data = {};
            projects.forEach(p => { data[p.id] = { status: p.status }; });
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        function loadFromLocalStorage() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                if (!raw) return;
                const data = JSON.parse(raw);
                projects.forEach(p => {
                    if (data[p.id] && data[p.id].status) {
                        p.status = data[p.id].status;
                    }
                });
            } catch (e) {
                console.error('[localStorage] Load error:', e);
            }
        }

        // ==========================================
        // Supabase Sync (Primary)
        // ==========================================
        async function syncFromSupabase() {
            if (!supabaseClient) return;
            try {
                const { data, error } = await supabaseClient
                    .from('gov_projects')
                    .select('id, status');

                if (error) throw error;

                if (data && data.length > 0) {
                    isSupabaseOnline = true;
                    data.forEach(row => {
                        const project = projects.find(p => p.supabaseId === row.id);
                        if (project) {
                            // í•œê¸€ ìƒíƒœ â†’ ì˜ì–´ key ë³€í™˜
                            const mappedKey = STATUS_KR_TO_KEY[row.status];
                            if (mappedKey) {
                                project.status = mappedKey;
                            }
                        }
                    });
                    // Supabase ë°ì´í„°ë¡œ localStorage ë®ì–´ì“°ê¸°
                    saveToLocalStorage();
                    renderAll();
                    console.log('[Supabase] Sync complete â€” ' + data.length + ' projects loaded');
                }
                updateSyncStatus();
            } catch (e) {
                console.error('[Supabase] Sync error:', e);
                isSupabaseOnline = false;
                updateSyncStatus();
            }
        }

        async function saveToSupabase(projectId, newStatusKey) {
            if (!supabaseClient) return;

            const project = projects.find(p => p.id === projectId);
            if (!project) return;

            const statusKR = STATUS_KEY_TO_KR[newStatusKey];
            if (!statusKR) {
                console.error('[Supabase] Unknown status key:', newStatusKey);
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('gov_projects')
                    .update({
                        status: statusKR,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', project.supabaseId);

                if (error) throw error;
                isSupabaseOnline = true;
                console.log('[Supabase] Saved: ' + project.title + ' â†’ ' + statusKR);
            } catch (e) {
                console.error('[Supabase] Save error:', e);
                isSupabaseOnline = false;
                showIndicator('error', 'âš  DB ì €ì¥ ì‹¤íŒ¨ (ë¡œì»¬ ì €ì¥ë¨)');
            }
            updateSyncStatus();
        }

        function updateSyncStatus() {
            const el = document.getElementById('syncStatus');
            if (!el) return;
            if (isSupabaseOnline) {
                el.className = 'sync-status online';
                el.textContent = 'ğŸŸ¢ DB ì—°ê²°ë¨';
            } else {
                el.className = 'sync-status offline';
                el.textContent = 'ğŸ”´ ì˜¤í”„ë¼ì¸ (ë¡œì»¬ ì €ì¥)';
            }
        }

        // ==========================================
        // D-Day Calculation
        // ==========================================
        function calculateDDay(deadlineStr) {
            if (!deadlineStr) return null;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const deadline = new Date(deadlineStr);
            const deadlineDay = new Date(deadline);
            deadlineDay.setHours(0, 0, 0, 0);
            const diffTime = deadlineDay.getTime() - today.getTime();
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        function getDDayText(diffDays) {
            if (diffDays === null) return null;
            if (diffDays < 0) return `D+${Math.abs(diffDays)}`;
            if (diffDays === 0) return 'D-Day';
            return `D-${diffDays}`;
        }

        function getDDayClass(diffDays) {
            if (diffDays === null) return 'complete';
            if (diffDays > 21) return 'safe';
            if (diffDays > 7) return 'warning';
            return '';
        }

        // ==========================================
        // Date Formatting
        // ==========================================
        function formatDeadline(deadlineStr) {
            if (!deadlineStr) return '-';
            const d = new Date(deadlineStr);
            const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            const month = d.getMonth() + 1;
            const date = d.getDate();
            const day = dayNames[d.getDay()];
            const hours = d.getHours();
            const minutes = d.getMinutes();
            if (hours === 0 && minutes === 0) {
                return `${month}/${date} (${day})`;
            }
            return `${month}/${date} (${day}) ${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
        }

        // ==========================================
        // Save Indicator
        // ==========================================
        const saveIndicator = document.getElementById('saveIndicator');
        function showIndicator(type, message) {
            saveIndicator.className = 'save-indicator show ' + type;
            saveIndicator.textContent = message;
            if (type !== 'saving') {
                setTimeout(() => { saveIndicator.classList.remove('show'); }, 2000);
            }
        }

        // ==========================================
        // Render Pipeline
        // ==========================================
        function renderPipeline() {
            const container = document.getElementById('pipelineContainer');
            container.innerHTML = '';
            STATUSES.forEach(s => {
                const div = document.createElement('div');
                div.className = `pipeline-stage ${s.stageClass}${s.key === currentFilter ? ' active' : ''}`;
                div.dataset.filter = s.key;
                const countValue = s.key === 'deadline' ? 'â€”' : getCount(s.key);
                div.innerHTML = `
                    <div class="stage-icon">${s.icon}</div>
                    <div class="stage-count" id="count-${s.key}">${countValue}</div>
                    <div class="stage-label">${s.label}</div>
                `;
                div.addEventListener('click', () => handleFilter(s.key));
                container.appendChild(div);
            });
        }

        function getCount(statusKey) {
            if (statusKey === 'all') return projects.length;
            return projects.filter(p => p.status === statusKey).length;
        }

        function updateCounts() {
            STATUSES.forEach(s => {
                if (s.key === 'deadline') return;
                const el = document.getElementById('count-' + s.key);
                if (el) el.textContent = getCount(s.key);
            });
        }

        // ==========================================
        // Render Cards
        // ==========================================
        function renderCards(projectList) {
            const grid = document.getElementById('cardsGrid');
            grid.innerHTML = '';
            const statusOptions = STATUSES.filter(s => s.key !== 'all' && s.key !== 'deadline');

            projectList.forEach(project => {
                const dday = calculateDDay(project.deadline);
                const ddayText = getDDayText(dday);
                const ddayClass = getDDayClass(dday);
                const isCompleted = ['selected', 'rejected', 'dropped'].includes(project.status);

                let ddayBadge = '';
                if (isCompleted && !project.deadline) {
                    const statusLabel = STATUSES.find(s => s.key === project.status);
                    ddayBadge = `<div class="d-day complete">${statusLabel ? statusLabel.label : ''}</div>`;
                } else if (ddayText) {
                    ddayBadge = `<div class="d-day ${ddayClass}">${ddayText}</div>`;
                }

                const optionsHTML = statusOptions.map(s =>
                    `<option value="${s.key}"${project.status === s.key ? ' selected' : ''}>${s.icon} ${s.label}</option>`
                ).join('');

                const noteHTML = project.note
                    ? `<div class="info-item"><div class="info-label">ë¹„ê³ </div><div class="info-value">${project.note}</div></div>`
                    : '';

                const card = document.createElement('div');
                card.className = 'project-card visible';
                card.dataset.stage = project.status;
                card.dataset.projectId = project.id;
                if (project.deadline) card.dataset.deadline = project.deadline;

                card.innerHTML = `
                    <div class="card-header">
                        <div>
                            <div class="card-title">${project.title}</div>
                            <div class="card-org">${project.agency}</div>
                        </div>
                        ${ddayBadge}
                    </div>
                    <div class="card-body">
                        <div class="card-info">
                            <div class="info-item"><div class="info-label">ë§ˆê°ì¼</div><div class="info-value">${formatDeadline(project.deadline)}</div></div>
                            <div class="info-item"><div class="info-label">ì˜ˆì‚°/í˜œíƒ</div><div class="info-value">${project.budget}</div></div>
                            <div class="info-item${project.note ? '' : ' full-width'}"><div class="info-label">ìœ í˜•</div><div class="info-value">${project.category}</div></div>
                            ${noteHTML}
                        </div>
                        <div class="status-dropdown-wrapper">
                            <div class="status-dropdown-label">ìƒíƒœ ë³€ê²½</div>
                            <select class="status-dropdown status-${project.status}" data-project-id="${project.id}" onchange="handleStatusChange(this)">
                                ${optionsHTML}
                            </select>
                        </div>
                        <a href="${project.link}" target="_blank" class="link-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>
                            ê³µê³  ë°”ë¡œê°€ê¸°
                        </a>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // ==========================================
        // Status Change Handler
        // ==========================================
        function handleStatusChange(selectElement) {
            const projectId = selectElement.dataset.projectId;
            const newStatus = selectElement.value;

            showIndicator('saving', 'ğŸ’¾ ì €ì¥ ì¤‘...');

            const project = projects.find(p => p.id === projectId);
            if (project) {
                project.status = newStatus;

                // 1. localStorage ì¦‰ì‹œ ì €ì¥
                saveToLocalStorage();

                // 2. Supabase ë¹„ë™ê¸° ì €ì¥
                saveToSupabase(projectId, newStatus).then(() => {
                    showIndicator('saved', 'âœ“ ì €ì¥ ì™„ë£Œ (DB + ë¡œì»¬)');
                }).catch(() => {
                    showIndicator('error', 'âš  DB ì‹¤íŒ¨ (ë¡œì»¬ë§Œ ì €ì¥ë¨)');
                });

                // 3. UI ì¦‰ì‹œ ê°±ì‹ 
                renderAll();
            }
        }

        // ==========================================
        // Filtering & Sorting
        // ==========================================
        let currentFilter = 'all';

        function handleFilter(filterKey) {
            currentFilter = filterKey;
            document.querySelectorAll('.pipeline-stage').forEach(s => s.classList.remove('active'));
            const activeStage = document.querySelector(`.pipeline-stage[data-filter="${filterKey}"]`);
            if (activeStage) activeStage.classList.add('active');
            renderFilteredCards();
        }

        function renderFilteredCards() {
            const filterInfo = document.getElementById('filterInfo');
            const emptyState = document.getElementById('emptyState');

            let filtered;
            if (currentFilter === 'all') {
                filtered = [...projects];
            } else if (currentFilter === 'deadline') {
                filtered = sortProjectsByDeadline([...projects]);
            } else {
                filtered = projects.filter(p => p.status === currentFilter);
            }

            renderCards(filtered);

            const statusObj = STATUSES.find(s => s.key === currentFilter);
            const label = statusObj ? statusObj.label : 'ì „ì²´';
            filterInfo.textContent = currentFilter === 'deadline'
                ? `ë§ˆê°ì¼ììˆœ ${filtered.length}ê±´`
                : `${label} ${filtered.length}ê±´`;

            emptyState.classList.toggle('visible', filtered.length === 0);
        }

        function sortProjectsByDeadline(list) {
            return list.sort((a, b) => {
                const aCompleted = ['selected', 'rejected', 'dropped'].includes(a.status);
                const bCompleted = ['selected', 'rejected', 'dropped'].includes(b.status);
                if (aCompleted && !bCompleted) return 1;
                if (!aCompleted && bCompleted) return -1;
                if (aCompleted && bCompleted) return 0;
                const aDay = calculateDDay(a.deadline);
                const bDay = calculateDDay(b.deadline);
                const aDDayVal = aDay === null ? Infinity : aDay;
                const bDDayVal = bDay === null ? Infinity : bDay;
                const aRed = aDay !== null && aDay <= 7;
                const bRed = bDay !== null && bDay <= 7;
                if (aRed && !bRed) return -1;
                if (!aRed && bRed) return 1;
                return aDDayVal - bDDayVal;
            });
        }

        // ==========================================
        // Header Date
        // ==========================================
        function updateHeaderDate() {
            const now = new Date();
            const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            const dateText = `ğŸ“… ${now.getFullYear()}. ${now.getMonth() + 1}. ${now.getDate()} (${dayNames[now.getDay()]}) ì—…ë°ì´íŠ¸`;
            const syncBadge = `<span id="syncStatus" class="sync-status offline">â³ ì—°ê²° ì¤‘...</span>`;
            document.querySelector('.update-date').innerHTML = dateText + ' ' + syncBadge;
        }

        // ==========================================
        // Render All
        // ==========================================
        function renderAll() {
            renderPipeline();
            updateCounts();
            renderFilteredCards();
        }

        // ==========================================
        // Initialize
        // ==========================================
        document.addEventListener('DOMContentLoaded', async () => {
            // 1. localStorageì—ì„œ ìš°ì„  ë¡œë“œ (ì¦‰ì‹œ ë Œë”ë§)
            loadFromLocalStorage();
            updateHeaderDate();
            renderAll();

            // 2. Supabaseì—ì„œ ìµœì‹  ë°ì´í„° ë™ê¸°í™” (ë¹„ë™ê¸°)
            await syncFromSupabase();
        });
    </script>
</body>
</html>